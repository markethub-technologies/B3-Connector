# Stage "sucio" / setup: se puede usar para instalaciones pesadas o tooling extra
FROM mcr.microsoft.com/devcontainers/cpp:ubuntu-24.04 AS setup-env

# Forzar uso de GCC/G++
ENV CC=/usr/bin/gcc
ENV CXX=/usr/bin/g++

# Si se necesita instalar tooling extra solo para generar artefactos futuros,
# se hace acá. Por ahora, dejamos solo un update básico (sin cosas específicas).
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# Stage limpio para el devcontainer final
FROM mcr.microsoft.com/devcontainers/cpp:ubuntu-24.04

ENV CC=/usr/bin/gcc
ENV CXX=/usr/bin/g++

RUN apt-get update && apt-get install -y --no-install-recommends \
    ninja-build \
    cmake \
    pkg-config \
    libzmq3-dev \
    libczmq-dev \
    cppzmq-dev \
    libsodium-dev \
    libpgm-5.3-0 \
    libnorm-dev \
    jq \
    libspdlog-dev \
 && rm -rf /var/lib/apt/lists/*

# Si en el futuro setup-env genera algo en /usr/local, se podría copiar:
# COPY --from=setup-env /usr/local/ /usr/local/

# ============================================================
# Copiar protobuf precompilado desde el contexto de build
# Build context is parent directory, so path is relative to B3-Connector/
# ============================================================
ARG PROTOBUF_VERSION=28.3
ARG PROTO_CACHE_VERSION=v2
COPY b3-md-connector/.devcontainer/cache/protobuf-${PROTOBUF_VERSION}-ubuntu2404-gcc-${PROTO_CACHE_VERSION}.tar.gz /tmp/protobuf.tar.gz

# Extraer e instalar protobuf en /usr/local
RUN echo "==> Installing protobuf ${PROTOBUF_VERSION} from cache..." && \
    tar -xzf /tmp/protobuf.tar.gz -C / && \
    ldconfig && \
    rm -f /tmp/protobuf.tar.gz && \
    echo "==> ✅ Protobuf ${PROTOBUF_VERSION} installed"

WORKDIR /workspaces/MarketHub.B3Connector