<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.11"/>
    <title>OnixS C++ B3 BOE Binary Order Entry: Solarflare-specific Features</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="onixs-doxygen.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript">
    $(window).scroll(function() {
        if ($(this).scrollTop() > 1)
        {
            $('header').addClass("sticky");
        }
        else
        {
            $('header').removeClass("sticky");
        }
    });
    </script>
</head>
<body>
<header>
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
<tbody>
    <tr style="height: 56px;">
        <td id="projectlogo"><a href="http://www.onixs.biz"><img alt="Logo" src="onixs.svg"/></a></td>
        <td style="padding-left: 0.5em;">
            <div id="projectname">OnixS C++ B3 BOE Binary Order Entry
            &#160;<span id="projectnumber">1.3.0</span>
            </div>
            <div id="projectbrief">API Documentation</div>
        </td>
    </tr>
</tbody>
</table>
</div>
</header>
<div id="wrapper">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="modules.html"><span>Contents</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Solarflare-specific Features<div class="ingroups"><a class="el" href="group__advanced-programming.html">Advanced Programming</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="solarflare-onload"></a>
Solarflare Onload</h1>
<p>Solarflare Onload is a sockets acceleration technology for the transparent acceleration of sockets-based applications.</p>
<p>On Linux, the Handler uses <a href="https://solarflare.com/onload/">Solarflare Onload</a> Extensions API to support additional features of Solarflare network cards. If one uses such network cards, in your system, you can benefit from advanced features of such network cards. B3 BOE Handler automatically detects if the corresponding Onload library installed in your system and, if so, then loads it in run-time and provides an ability to use additional features. In this case, there should be the record, in the Handler log, that the corresponding version of the Onload extension library is used.</p>
<dl class="section note"><dt>Note</dt><dd>If one wants to test Onload features on the loopback network interface, <code>EF_TCP_CLIENT_LOOPBACK</code> and <code>EF_TCP_SERVER_LOOPBACK</code> parameters should be used, e.g.: <code>EF_TCP_CLIENT_LOOPBACK=2 EF_TCP_SERVER_LOOPBACK=2 onload ..</code>.</dd></dl>
<p>Please see the "Onload User Guide".</p>
<p>Currently, the Handler supports the following Onload features:</p>
<ul>
<li>Onload message warmup</li>
</ul>
<p>When one uses the <a class="el" href="classOnixS_1_1B3_1_1BOE_1_1Session.html#a80e73ea445447edb4e6952a0304d28f3" title="Warms up the sending path. ">OnixS::B3::BOE::Session::warmUp</a> method, the Handler automatically enables this feature. As a result, one can get the maximal warm-up effect, including the complete warm-up of the TCP stack's sending path.</p>
<p>The <code>onload_stackdump</code> utility could be used to monitor the usage of this feature.</p>
<p>For example: </p><pre class="fragment">onload_stackdump lots | grep warm
</pre><hr/>
<h1><a class="anchor" id="tcpdirect"></a>
Solarflare TCPDirect</h1>
<p>Solarflare TCPDirect is an ultra-low latency network stack.</p>
<h2><a class="anchor" id="tcpdirect-stack-creation"></a>
Creating OnixS TcpDirectStack</h2>
<p>Before TCPDirect sessions can be created, the application must first create a TCPDirect stack (<a class="el" href="classOnixS_1_1B3_1_1BOE_1_1TcpDirectStack.html" title="A high-level wrapper over the TCPDirect network stack. ">OnixS::B3::BOE::TcpDirectStack</a>): </p><div class="fragment"><div class="line"></div><div class="line">TcpDirectAttr attr;</div><div class="line"><span class="comment">// The default interface name could be provided by environment variable</span></div><div class="line"><span class="comment">//     ZF_ATTR=&quot;interface=&lt;interface-name&gt;&quot;, see TCPDirect specs,</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// or could be set manually:</span></div><div class="line"><span class="comment">//     attr.set(&quot;interface&quot;, &quot;interface-name&quot;);</span></div><div class="line"></div><div class="line">TcpDirectStack tcpDirectStack(attr);</div><div class="line"></div></div><!-- fragment --><p> Attributes (<a class="el" href="classOnixS_1_1B3_1_1BOE_1_1TcpDirectAttr.html" title="TCPDirect Attributes to pass configuration details (a wrapper around the zf_attr struct). ">OnixS::B3::BOE::TcpDirectAttr</a>) control the configuration of the stack and its behavior, please see the Solarflare TCPDirect User Guide for a complete list of available attributes and their description.</p>
<p>TCPDirect sessions should be created in the same thread where TcpDirectStack has been created. The reference to the stack is provided in Session's constructor, for example: </p><div class="fragment"><div class="line"></div><div class="line">Session session(tcpDirectStack, settings, &amp;listener, storageType);</div><div class="line"></div></div><!-- fragment --><p> By default, each TCPDirect stack can handle up to 64 TCP endpoints, so those number of sessions could be created. Maximum number of TCP endpoints can be set by <code>max_tcp_endpoints</code> attribute. Please refer to Solarflare TCPDirect documentation. See also <code>max_tcp_listen_endpoints</code>, <code>max_tcp_syn_backlog</code>, <code>max_udp_rx_endpoints</code>, <code>max_udp_tx_endpoints</code> attributes. These attributes could be set to a minimum value to save hardware and software resources.</p>
<h2><a class="anchor" id="tcpdirect-event-loop"></a>
Dispatching network events, asynchronous connect and disconnect</h2>
<p>External code on top of TCPDirect can be implemented as an event loop.</p>
<p>The need to scroll through the loop means the inability to use blocking calls because blocking calls will stop the event's dispatching. Therefore, user code must call asynchronous Session's methods to connect and disconnect, for example: </p><div class="fragment"><div class="line"></div><div class="line"><span class="comment">// some application-managed variable that could be changed by some events</span></div><div class="line"><span class="keywordtype">bool</span> finished = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">Threading::SharedFuture&lt;void&gt; connected = session.connectAsync(host, port);</div><div class="line"></div><div class="line"><span class="comment">// The TCPDirect technology is NOT thread-safe.</span></div><div class="line"><span class="comment">// Therefore, the event dispatching and message sending should be performed from the same thread.</span></div><div class="line"><span class="keywordflow">while</span>(!connected.is_ready())</div><div class="line">    tcpDirectStack.dispatchEvents();</div><div class="line"></div><div class="line"><span class="keywordflow">if</span>(connected.has_exception())</div><div class="line">    connected.get();    <span class="comment">// will throw an exception</span></div><div class="line"></div><div class="line"><span class="keywordflow">while</span>(!finished)</div><div class="line">    tcpDirectStack.dispatchEvents();</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="tcpdirect-stack-shutdown"></a>
TcpDirectStack shutdown</h2>
<p>In general, TCPDirect stack requires to finish all outstanding work and to handle all outstanding events. Before destroying the TcpDirectStack instance, the following code should be executed: </p><div class="fragment"><div class="line"></div><div class="line"><span class="keywordflow">while</span>(!tcpDirectStack.isQuiescent())</div><div class="line">    tcpDirectStack.dispatchEvents();</div><div class="line"></div></div><!-- fragment --><p> Method <code>TcpDirectStack::isQuiescent()</code> (<a class="el" href="classOnixS_1_1B3_1_1BOE_1_1TcpDirectStack.html#a17244859fcb1f186ac73ff9002045076">OnixS::B3::BOE::TcpDirectStack::isQuiescent</a>) returns a boolean value indicating whether a stack is quiescent.</p>
<p>This can be used to ensure that all connections have been closed gracefully before destroying a stack (or exiting the application). Destroying a stack while it is not quiescent is permitted by the API, but when doing so there is no guarantee that sent data has been acknowledged by the peer or even transmitted, and there is the possibility that peers' connections will be reset.</p>
<h2><a class="anchor" id="tcpdirect-threading-model"></a>
TCPDirect threading model</h2>
<dl class="section warning"><dt>Warning</dt><dd>Access to the stack instance at each moment is possible from only <b>one</b> thread. The TCPDirect middle-ware does <b>not</b> use inter-threaded synchronization, does <b>not</b> serialize calls, and does <b>not</b> check the correctness of access to its API by the user. Therefore, <b>the event dispatching and message sending should be performed from the same thread</b>.</dd></dl>
<h2><a class="anchor" id="tcpdirect-emulator"></a>
TCPDirect emulator for Windows</h2>
<p>The TCPDirect API does not support loopback connections as opposed to regular sockets.</p>
<p>To facilitate the development and debugging of applications based on TCPDirect <a class="el" href="namespaceOnixS.html">OnixS</a> B3 BOE Handler contains the TCPDirect emulator for Windows on top of regular sockets with call correctness verification.</p>
<p>Unlike the original technology, the TCPDirect emulator allows you to create a loopback connection, which also helps the application debugging process.</p>
<p>TCPDirect emulator does not require additional configuration, it activated automatically under Windows when TcpDirectStack object is created and used.</p>
<p>Native TCPDirect-connections should belong to the corresponding Solarflare hardware interface. In Windows emulation mode it could be any existing network interface that allows binding the sockets to it. In most common debugging scenarios is recommended to use the same interface (and its IP address) both for an exchange emulator (<a class="el" href="classOnixS_1_1B3_1_1BOE_1_1Testing_1_1Gateway.html" title="B3 BOE Gateway Emulator. ">OnixS::B3::BOE::Testing::Gateway</a>) and TCPDirect-emulated client connection.</p>
<dl class="section warning"><dt>Warning</dt><dd>Under Windows TCPDirect emulator, destroying a stack while it is not quiescent may cause a memory leak.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__tcp-direct-getting-started-sample.html">TCPDirect Getting Started Sample</a> </dd>
<dd>
<a class="el" href="group__tcp-direct-benchmark-sample.html">TCPDirect Benchmark Sample</a> </dd></dl>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<footer>
<hr class="footer"/>
<address class="footer">
    <small>&copy; <a href="http://www.onixs.biz">Onix Solutions [On<span class="corporate-orange">i</span>x<span class="corporate-orange">S</span>]</a>. All rights reserved.</small>
</address>
</footer>
</div> <!-- wrapper -->
</body>
</html>
